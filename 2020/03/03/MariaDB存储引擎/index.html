<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="我们之前初步了解了MariaDB, 接着学习了MySQL的一些关于权限, 缓存和索引的东西. 接下来我们继续聊聊关于存储引擎的相关知识.">
<meta name="keywords" content="Database">
<meta property="og:type" content="article">
<meta property="og:title" content="MariaDB存储引擎和事务">
<meta property="og:url" content="https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/index.html">
<meta property="og:site_name" content="Yaoxuannn&#39;s Blog">
<meta property="og:description" content="我们之前初步了解了MariaDB, 接着学习了MySQL的一些关于权限, 缓存和索引的东西. 接下来我们继续聊聊关于存储引擎的相关知识.">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://hexopic.s3.ap-northeast-1.amazonaws.com/show_engine_percona_xtraDB.png">
<meta property="og:image" content="https://hexopic.s3.ap-northeast-1.amazonaws.com/%E4%BA%8B%E5%8A%A1%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png">
<meta property="og:image" content="https://hexopic.s3.ap-northeast-1.amazonaws.com/%E5%B9%BB%E8%AF%BB_from_Wikipedia.png">
<meta property="og:updated_time" content="2020-03-08T06:46:14.758Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MariaDB存储引擎和事务">
<meta name="twitter:description" content="我们之前初步了解了MariaDB, 接着学习了MySQL的一些关于权限, 缓存和索引的东西. 接下来我们继续聊聊关于存储引擎的相关知识.">
<meta name="twitter:image" content="https://hexopic.s3.ap-northeast-1.amazonaws.com/show_engine_percona_xtraDB.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>MariaDB存储引擎和事务</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2020/01/10/Kubernetes架构基础/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&text=MariaDB存储引擎和事务"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&is_video=false&description=MariaDB存储引擎和事务"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MariaDB存储引擎和事务&body=Check out this article: https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&name=MariaDB存储引擎和事务&description=&lt;p&gt;我们之前初步了解了MariaDB, 接着学习了MySQL的一些关于权限, 缓存和索引的东西. 接下来我们继续聊聊关于存储引擎的相关知识.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB存储引擎"><span class="toc-number">1.</span> <span class="toc-text">InnoDB存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyISAM存储引擎"><span class="toc-number">2.</span> <span class="toc-text">MyISAM存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他的一些存储引擎"><span class="toc-number">3.</span> <span class="toc-text">其他的一些存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSV存储引擎"><span class="toc-number">3.1.</span> <span class="toc-text">CSV存储引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MRG-MYISAM"><span class="toc-number">3.2.</span> <span class="toc-text">MRG_MYISAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BLACKHOLE"><span class="toc-number">3.3.</span> <span class="toc-text">BLACKHOLE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MEMORY"><span class="toc-number">3.4.</span> <span class="toc-text">MEMORY</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PERFORMANCE-SCHEMA"><span class="toc-number">3.5.</span> <span class="toc-text">PERFORMANCE_SCHEMA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARCHIVE"><span class="toc-number">3.6.</span> <span class="toc-text">ARCHIVE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL的并发控制"><span class="toc-number">4.</span> <span class="toc-text">MySQL的并发控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL的事务"><span class="toc-number">5.</span> <span class="toc-text">MySQL的事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#事务隔离级别"><span class="toc-number">5.1.</span> <span class="toc-text">事务隔离级别</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MariaDB存储引擎和事务
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Yaoxuannn's Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-03-03T13:28:47.000Z" itemprop="datePublished">2020-03-03</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Database/">Database</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>我们之前初步了解了MariaDB, 接着学习了MySQL的一些关于权限, 缓存和索引的东西. 接下来我们继续聊聊关于存储引擎的相关知识.</p>
<a id="more"></a>

<p>我们之前聊过MySQL的架构, 其中, 有很多可插拔的第三方或者社区支持的<strong>存储引擎</strong>, 说到底MySQL的很多特性都是来源于存储引擎的, 其中比较有名的就是MyISAM和InnoDB, 相比于MyISAM, InnoDB支持事务, 这一点就让InnoDB让更多人选择, 或者成为默认的存储引擎(5.5版本之后). 但是当然啦, 存储引擎不止这两个, 还有很多的, 接下来我们就来就其中几个比较重要的来做说明.</p>
<h2 id="InnoDB存储引擎"><a href="#InnoDB存储引擎" class="headerlink" title="InnoDB存储引擎"></a>InnoDB存储引擎</h2><p>我们在创建一个新表的时候, 就会指明使用到的存储引擎. (CREATE TABLE … ENGINE=…), 所以说到底, 存储引擎是一个表级别的概念, 就是表的类型.</p>
<p>首当其中就是InnoDB了. InnoDB的设计目标是处理大量的短期事务, 并且, 在机器宕机, 出现断电等导致内存数据还没有被写入到磁盘中的情况下, InnoDB可以自动的进行数据的修复, 这样的一大好处就是避免数据的不一致, 而MyISAM不具备这样的特性, 从而只能进行手动的修复, 手动的修复就会很容易的造成数据不一致(inconsistent).</p>
<p>InnoDB的数据存储在<strong>表空间</strong>中. 这个表空间就是InnoDB组织数据的”黑盒子”, 在文件系统上表现为一个由InnoDB理解的文件系统. 因此, InnoDB也可以支持裸设备, 即是说, 你可以直接分个区无需格式化从而直接供InnoDB使用.</p>
<p>对于InnoDB来说, 有多种存放数据的策略:</p>
<ul>
<li>所有的InnoDB表的数据, 索引, 都放置在同一个表空间中. (不易管理, 一些操作不被支持)</li>
<li>每个表使用单独的表空间存储表的数据和索引 <code>(innodb_file_per_table=ON)</code></li>
</ul>
<p>对于第一种存放的方式, 在datadir定义的目录下, 会出现<code>idbdata</code>开头的文件, 自动编号.</p>
<p>我们来看看默认配置下, datadir下的文件样子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql]<span class="comment"># ls -l /var/lib/mysql/</span></span><br><span class="line">total 28704</span><br><span class="line">-rw-rw----. 1 mysql mysql    16384 Mar  4 10:26 aria_log.00000001</span><br><span class="line">-rw-rw----. 1 mysql mysql       52 Mar  4 10:26 aria_log_control</span><br><span class="line">drwx------. 2 mysql mysql     4096 Mar  4 12:17 hellodb</span><br><span class="line">-rw-rw----. 1 mysql mysql 18874368 Mar  4 10:26 ibdata1</span><br><span class="line">-rw-rw----. 1 mysql mysql  5242880 Mar  4 10:26 ib_logfile0</span><br><span class="line">-rw-rw----. 1 mysql mysql  5242880 Mar  4 10:26 ib_logfile1</span><br><span class="line">drwx------. 2 mysql mysql     4096 Mar  4 10:26 mysql</span><br><span class="line">srwxrwxrwx. 1 mysql mysql        0 Mar  4 10:26 mysql.sock</span><br><span class="line">drwx------. 2 mysql mysql     4096 Mar  4 10:26 performance_schema</span><br></pre></td></tr></table></figure>

<p>其中的ibdata1就是我们的表空间了.</p>
<p>接下来我们修改配置加上<code>innodb_file_per_table</code>之后, 来创建一个新表试试.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; create database mydb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use mydb;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [mydb]&gt; create table t1 (id int, name char(30));</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [mydb]&gt; Bye</span><br><span class="line">[root@node1 mysql]<span class="comment"># ls /var/lib/mysql/mydb/ -l</span></span><br><span class="line">total 208</span><br><span class="line">-rw-rw----. 1 mysql mysql    65 Mar  8 11:32 db.opt</span><br><span class="line">-rw-rw----. 1 mysql mysql  8586 Mar  8 11:32 t1.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql 98304 Mar  8 11:32 t1.ibd</span><br></pre></td></tr></table></figure>

<p>可以看到, 在这个数据库目录下, 有一个叫做<code>t1.ibd</code>的文件. 这个玩意就是表空间文件, 表现为<code>table_name.ibd</code>这个样子. 另外的一个<code>*.frm</code>的文件是表格式定义(format).</p>
<p>接下来我们快速过一遍InnoDB的一些特性:</p>
<ul>
<li>基于MVCC来支持高并发 – MVCC-Multi Version Concurrency Control</li>
<li>支持所有的事务隔离级别, 默认级别: REPEATABLE READ</li>
<li>使用间隙锁防止幻读</li>
<li>使用聚集索引</li>
<li>支持”自适应哈希索引” – Adaptive Hash Index</li>
<li>支持热备 (在线) – <code>xtrabackup</code></li>
<li>支持行级锁</li>
</ul>
<p>我们之前在介绍MariaDB的时候就说过, 它使用的其实不是InnoDB存储引擎, 而是一个社区的改良版, <code>XtraDB</code>. 其实在我们列出存储引擎的时候就能看到:</p>
<p><img src="https://hexopic.s3.ap-northeast-1.amazonaws.com/show_engine_percona_xtraDB.png" alt="show_engine_percona_xtraDB"></p>
<p>这个Percona是一个著名的MySQL的技术顾问公司.</p>
<h2 id="MyISAM存储引擎"><a href="#MyISAM存储引擎" class="headerlink" title="MyISAM存储引擎"></a>MyISAM存储引擎</h2><p>接下来我们再来说MyISAM, 这个存储引擎早期是针对一些数据仓库设计的, 即较少的写操作, 较多的读操作. 因为不适合在线事务处理. 但MyISAM是MySQL很早期的存储引擎, 因此是十分成熟的. 并且他还有一个很棒的特性就是支持全文索引(<code>FULLTEXT idnex</code>), 可以压缩, 支持空间函数. 相较于InnoDB精细的锁粒度, MyISAM是表级的锁, 因此十分容易出现竞争态. 还有就是我们说过的, 不支持安全恢复.</p>
<p>因此在MariaDB中, 我们使用MyISAM的时候, 就会使用<code>Aria</code>存储引擎, 你可以在上面的图中的最后一行看到. 这就是支持安全恢复的MyISAM存储引擎.</p>
<p>那么MyISAM是如何存储数据的呢? 我们之前使用的hellodb数据库就是使用的MyISAM引擎, 我们来看看:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># ls /var/lib/mysql/hellodb/ -l</span></span><br><span class="line">total 140</span><br><span class="line">-rw-rw----. 1 mysql mysql 8636 Mar  4 12:17 classes.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql  172 Mar  4 12:17 classes.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql 2048 Mar  4 12:17 classes.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql 8630 Mar  4 12:17 coc.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql  112 Mar  4 12:17 coc.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql 2048 Mar  4 12:17 coc.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql 8602 Mar  4 12:17 courses.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql  144 Mar  4 12:17 courses.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql 2048 Mar  4 12:17 courses.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql   61 Mar  4 12:17 db.opt</span><br><span class="line">-rw-rw----. 1 mysql mysql 8658 Mar  4 12:17 scores.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql  180 Mar  4 12:17 scores.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql 2048 Mar  4 12:17 scores.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql 8736 Mar  4 12:17 students.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql  624 Mar  4 12:17 students.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql 2048 Mar  4 12:17 students.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql 8656 Mar  4 12:17 teachers.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql   92 Mar  4 12:17 teachers.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql 2048 Mar  4 12:17 teachers.MYI</span><br><span class="line">-rw-rw----. 1 mysql mysql 8622 Mar  4 12:17 toc.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql    0 Mar  4 12:17 toc.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql 1024 Mar  4 12:17 toc.MYI</span><br></pre></td></tr></table></figure>

<p>可以看到一共有三种文件类型, <code>frm</code>,  <code>MYD</code>, <code>MYI</code>. 其实大概可以猜出来, 其中<code>frm</code>和上面一样是存储表的格式的, D代表Data, I代表Index, 因此, 对于MyISAM来说, 数据和索引是分开存放的. 每一个表都是这三个文件.</p>
<h2 id="其他的一些存储引擎"><a href="#其他的一些存储引擎" class="headerlink" title="其他的一些存储引擎"></a>其他的一些存储引擎</h2><h3 id="CSV存储引擎"><a href="#CSV存储引擎" class="headerlink" title="CSV存储引擎"></a>CSV存储引擎</h3><p>首先CSV (逗号分隔) 就是一种数据结构, 把它当做表来处理, 就是这么简单. </p>
<p>显然这是不支持索引的, 但是对于导出导入就很灵活.</p>
<h3 id="MRG-MYISAM"><a href="#MRG-MYISAM" class="headerlink" title="MRG_MYISAM"></a>MRG_MYISAM</h3><p>可以将多个MyISAM的表合并成为一个虚拟表.</p>
<h3 id="BLACKHOLE"><a href="#BLACKHOLE" class="headerlink" title="BLACKHOLE"></a>BLACKHOLE</h3><p>就是<code>/dev/null</code>, 没有实现任何的存储机制.</p>
<h3 id="MEMORY"><a href="#MEMORY" class="headerlink" title="MEMORY"></a>MEMORY</h3><p>内存存储引擎, 性能很好(因为全是内存表), 支持hash索引, 并且还有表级锁. 这个临时表存在一个存储的上限, 达到上限就会被写入到磁盘上.</p>
<h3 id="PERFORMANCE-SCHEMA"><a href="#PERFORMANCE-SCHEMA" class="headerlink" title="PERFORMANCE_SCHEMA"></a>PERFORMANCE_SCHEMA</h3><p>伪存储引擎, 用来记录MySQL的一些运行数据. 启动前和启动后都是空的.</p>
<h3 id="ARCHIVE"><a href="#ARCHIVE" class="headerlink" title="ARCHIVE"></a>ARCHIVE</h3><p>用于数据归档, 仅支持insert和select. 会缓存所有写并使用zlib进行压缩, 但是每一次的select都要进行全表扫描. 有行级锁和专用缓存区.</p>
<h2 id="MySQL的并发控制"><a href="#MySQL的并发控制" class="headerlink" title="MySQL的并发控制"></a>MySQL的并发控制</h2><p>接下来我们简单的说说, MySQL的读写锁.</p>
<p>读锁就是共享锁, 一个资源可以被多次增加读锁; 写锁就是独占锁, 或者说叫做排它锁. 那么对于并发访问控制而言, 锁的粒度就十分重要了, 比较常见的是, 表级锁和行级锁. 这里肯定不是越精细就越好, 精细的粒度带来的是更大的锁开销, 因此, 寻找一个锁策略可以在数据安全和锁粒度这两者中获取平衡就至关重要了.</p>
<p>几乎每种存储引擎都可以自行实现自己的锁策略和锁粒度, 同时MySQL在服务器级别也实现了锁, 默认的锁级别就是表级锁. 并且用户是可以进行显式请求施加锁的, 虽然这不是一件推荐做的事情, 因为大多数的情况下, 这些操作都是存储引擎自动完成的, 尽量应该避免用户的干预. 我们把这里的隐式锁叫做存储引擎自动施加的, 而显式锁就是用户手动添加.</p>
<p>接下来我们演示一下, 用户手动加锁的操作. 还是先看看帮助文档:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; <span class="built_in">help</span> lock</span><br><span class="line">Name: <span class="string">'LOCK'</span></span><br><span class="line">Description:</span><br><span class="line">Syntax:</span><br><span class="line">LOCK TABLES</span><br><span class="line">    tbl_name [[AS] <span class="built_in">alias</span>] lock_type</span><br><span class="line">    [, tbl_name [[AS] <span class="built_in">alias</span>] lock_type] ...</span><br><span class="line"></span><br><span class="line">lock_type:</span><br><span class="line">    READ [LOCAL]</span><br><span class="line">  | [LOW_PRIORITY] WRITE</span><br><span class="line"></span><br><span class="line">UNLOCK TABLES</span><br></pre></td></tr></table></figure>

<p>通过<code>lock tables</code>来指明加锁. 解锁使用<code>lock tables</code>.</p>
<p>现在我们登陆两个线程, 一个加锁, 另外一个尝试做操作, 来看看变化.</p>
<p>线程1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mydb]&gt; lock tables t1 write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [mydb]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<p>线程2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mydb]&gt; select SQL_NO_CACHE * from t1;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | name |</span><br><span class="line">+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [mydb]&gt; select SQL_NO_CACHE * from t1;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | name |</span><br><span class="line">+------+------+</span><br><span class="line">1 row in set (12.46 sec)</span><br></pre></td></tr></table></figure>

<p>其中, 第一次的查询操作是没有加锁的, 而第二次的查询时, 我们已经加锁了, 因此查询被堵塞. 在我们释放锁的一瞬间, 结果就返回了. 从查询的时间可以看出来, 这次查询是被堵塞了.</p>
<p>注意这个地方我在每次查询的时候都加上了<code>SQL_NO_CACHE</code>参数, 目的就是为了防止缓存. 如果你在加了写锁之后发现还可以访问数据, 那大概是来源于缓存, 这个时候你可以update表一次, 从而令缓存失效就可以了.</p>
<p>除了这样加锁, 我们还可以在查询的时候就加上锁, 也可以使用<code>FLUSH TABLES</code>来加锁. 不过这里就不赘述了.</p>
<h2 id="MySQL的事务"><a href="#MySQL的事务" class="headerlink" title="MySQL的事务"></a>MySQL的事务</h2><p>什么是<strong>事务</strong>嘞? 这可真是老生常谈了, 事务是一组原子性的SQL查询, 或者说是一个独立的工作单元. 任何一个事务都要经过ACID测试, 即:</p>
<ul>
<li>A: Atomicity: 原子性. 整个事务中的所有操作, 要么全部成功执行 , 要么全部失败回滚. 具体实现上, 我们需要撤销和重做日志.</li>
<li>C: Consistency: 一致性. 数据库总是从一个一致性状态转换至另外一个一致性状态.</li>
<li>I: Isolation: 隔离性. 一个事物所做出的的操作, 在提交之前, 是不能被其他的事务所看见的. 由此引入, 多种隔离级别, 隔离级别会影响到并发性能和数据的安全性.</li>
<li>D: Durability: 持久性. 一个事务提交, 其所作的修改会永久保存在数据库中.</li>
</ul>
<p>我们来看下事务的生命周期:</p>
<p><img src="https://hexopic.s3.ap-northeast-1.amazonaws.com/%E4%BA%8B%E5%8A%A1%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="事务的生命周期"></p>
<p>大体上, 我们需要显式启动事务, 接着进行一堆修改操作, 一旦提交, 就会持久保存. 或者, 进行回滚操作, 就会回到最初的状态.</p>
<p>当然, 只有支持事务的存储引擎才能支持上面的操作. 我们之前使用的测试sql是使用的MyISAM引擎, 我们可以修改成InnoDB来做测试.</p>
<p>事实上, 对于InnoDB而言, 默认每一条语句都是一个小事务, 有一个控制这个行为变量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show global variables like &apos;autocommit&apos;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| autocommit    | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>也就是自动提交, 这参数默认是开启的, 也就是所其实每一次的SQL的操作, 都会被打开一个事务, 然后自动提交. 这个行为其实是很消耗磁盘IO的, 所以建议显式的进行事务请求和提交, 就可以有效降低数据库的IO.</p>
<p>其实事务还支持<strong>保存点(save point)</strong>, 这个其实有点类似git的版本控制, 我们可以选择回滚到某一个位置, 来看文档:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; help savepoint;</span><br><span class="line">Name: &apos;SAVEPOINT&apos;</span><br><span class="line">Description:</span><br><span class="line">Syntax:</span><br><span class="line">SAVEPOINT identifier</span><br><span class="line">ROLLBACK [WORK] TO [SAVEPOINT] identifier</span><br><span class="line">RELEASE SAVEPOINT identifier</span><br><span class="line"></span><br><span class="line">InnoDB supports the SQL statements SAVEPOINT, ROLLBACK TO SAVEPOINT,</span><br><span class="line">RELEASE SAVEPOINT and the optional WORK keyword for ROLLBACK.</span><br></pre></td></tr></table></figure>

<p>我们可以直接选择回滚到某一个位置上.</p>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>接着我们来说说事务的隔离级别. 有以下的级别:</p>
<ul>
<li>READ UNCOMMITTED (读未提交)</li>
<li>READ COMMITTED (读提交)</li>
<li>REPEATABLE READ (可重读)</li>
<li>SERILIAZABLE (可串行化)</li>
</ul>
<p>在事务中, 会出现很多问题, 这些问题有:</p>
<ul>
<li>脏读: 读别的事务没有提交的数据</li>
<li>不可重复读: 数据两次读到的值不一样</li>
<li>幻读: 多个事务, 其中一个事务多次执行的结果在第二个事务的干预下产生了不一致.</li>
</ul>
<blockquote>
<p>关于这个地方, 我要稍微多说说关于这个幻读, 因为有点难以理解. SQL标准上的意思更多的是在强调: 查询结果出现了新增行. 举维基百科的例子就很清楚了:</p>
<p><img src="https://hexopic.s3.ap-northeast-1.amazonaws.com/%E5%B9%BB%E8%AF%BB_from_Wikipedia.png" alt="幻读_from_Wikipedia"></p>
</blockquote>
<p>对于这些问题, 不同的隔离级别会有不同的读问题.</p>
<p>定义MySQL的隔离级别的参数叫做<code>tx_isolation</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show global variables like &apos;%isolation%&apos;;</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| tx_isolation  | REPEATABLE-READ |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>可以看到我们现在用的是可重读.</p>
<p>说回到我们的InnoDB, 我们提到了一个特性叫做MVCC机制, 即多版本并发控制, 这个机制会在MySQL启动的时候存储数据集的快照, 然后通过这个快照来实现很多事务和并发操作. 不过这只是一点点浅显的实现, 关于MVCC的技术细节还是十分复杂的. 这里就略过啦.</p>
<p>但是, 尽管我们有事务, 还是可能会有新的问题, 考虑这样的场景. 一个事务进行提交, 其中包含大量的写语句, 假设现在使用的是机械硬盘, 机械硬盘的一个特性就是需要寻道. 如果我们的要操作的数据块是分散的, 大量的随机IO是需要消耗很多时间的, 假设正在寻道中, 数据库服务器崩了, 那么我的这些操作也就中断了, 数据就不一致了. 这咋办?</p>
<p>这就需要日志了, 还记得我们之前提到的事务日志吗? MySQL在提交事务操作的时候, 不会直接写到数据文件里面, 而是先写数据日志, 而这个事务日志文件是磁盘上连续的地址, 一次寻道, 就可以全部写进去. 这样的话, 如果数据库崩溃, 即使内存中缓冲区的数据被清掉了, 但是在重启的时候, 数据库会进行一次检查, 将事务日志的内容写到数据文件中. 另外, 这个事务日志一般都是多个出现, 一般是2个或者3个. 这是为了防止文件过大.</p>
<p>事务日志的写入类型都是 “追加”, 因此写入操作都是 “顺序IO”. 这些日志都是<strong>预写式日志(write ahead logging)</strong>.</p>
<p>事务日志是由存储引擎控制的, 我们来看看innodb的日志:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># ls /var/lib/mysql/ -lh</span></span><br><span class="line">total 29M</span><br><span class="line">-rw-rw----. 1 mysql mysql  16K Mar  8 11:30 aria_log.00000001</span><br><span class="line">-rw-rw----. 1 mysql mysql   52 Mar  8 11:30 aria_log_control</span><br><span class="line">drwx------. 2 mysql mysql  272 Mar  8 13:32 hellodb</span><br><span class="line">-rw-rw----. 1 mysql mysql  18M Mar  8 13:32 ibdata1</span><br><span class="line">-rw-rw----. 1 mysql mysql 5.0M Mar  8 13:32 ib_logfile0</span><br><span class="line">-rw-rw----. 1 mysql mysql 5.0M Mar  4 10:26 ib_logfile1</span><br><span class="line">drwx------. 2 mysql mysql   48 Mar  8 11:32 mydb</span><br><span class="line">drwx------. 2 mysql mysql 4.0K Mar  4 10:26 mysql</span><br><span class="line">srwxrwxrwx. 1 mysql mysql    0 Mar  8 11:30 mysql.sock</span><br><span class="line">drwx------. 2 mysql mysql 4.0K Mar  4 10:26 performance_schema</span><br></pre></td></tr></table></figure>

<p>我们可以看到两个一样大的文件<code>ib_logfile</code>, 这就是InnoDB的日志啦, 当然这个日志文件的大小也是可以调整的, 日志的数量也是可以调整的, 包括存放的位置都有变量控制:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show global variables like &apos;innodb_log%&apos;;</span><br><span class="line">+---------------------------+---------+</span><br><span class="line">| Variable_name             | Value   |</span><br><span class="line">+---------------------------+---------+</span><br><span class="line">| innodb_log_block_size     | 512     |</span><br><span class="line">| innodb_log_buffer_size    | 8388608 |</span><br><span class="line">| innodb_log_file_size      | 5242880 |</span><br><span class="line">| innodb_log_files_in_group | 2       |</span><br><span class="line">| innodb_log_group_home_dir | ./      |</span><br><span class="line">+---------------------------+---------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>


  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB存储引擎"><span class="toc-number">1.</span> <span class="toc-text">InnoDB存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyISAM存储引擎"><span class="toc-number">2.</span> <span class="toc-text">MyISAM存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他的一些存储引擎"><span class="toc-number">3.</span> <span class="toc-text">其他的一些存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSV存储引擎"><span class="toc-number">3.1.</span> <span class="toc-text">CSV存储引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MRG-MYISAM"><span class="toc-number">3.2.</span> <span class="toc-text">MRG_MYISAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BLACKHOLE"><span class="toc-number">3.3.</span> <span class="toc-text">BLACKHOLE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MEMORY"><span class="toc-number">3.4.</span> <span class="toc-text">MEMORY</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PERFORMANCE-SCHEMA"><span class="toc-number">3.5.</span> <span class="toc-text">PERFORMANCE_SCHEMA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARCHIVE"><span class="toc-number">3.6.</span> <span class="toc-text">ARCHIVE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL的并发控制"><span class="toc-number">4.</span> <span class="toc-text">MySQL的并发控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL的事务"><span class="toc-number">5.</span> <span class="toc-text">MySQL的事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#事务隔离级别"><span class="toc-number">5.1.</span> <span class="toc-text">事务隔离级别</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&text=MariaDB存储引擎和事务"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&is_video=false&description=MariaDB存储引擎和事务"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MariaDB存储引擎和事务&body=Check out this article: https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&title=MariaDB存储引擎和事务"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://yaoxuannn.com/2020/03/03/MariaDB存储引擎/&name=MariaDB存储引擎和事务&description=&lt;p&gt;我们之前初步了解了MariaDB, 接着学习了MySQL的一些关于权限, 缓存和索引的东西. 接下来我们继续聊聊关于存储引擎的相关知识.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Yaoxuan Wei
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'yaoxuannn-com';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


<script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
